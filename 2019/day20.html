<html>

<body>
    <script>

        const inp = `                                     S         N       I         Y       A     F                                       
                                     D         C       J         J       C     W                                       
  ###################################.#########.#######.#########.#######.#####.#####################################  
  #.......#.#...#.....#...#.....#.........#...#.....#.#.......#...#...........#.....#.................#.#...#.#.#.#.#  
  ###.###.#.###.#####.#.#.#####.###.#####.#.#.#.#.###.#.#########.###.###.#######.###.#####.###.###.###.###.#.#.#.#.#  
  #...#.#...#.#...#.#...#.#.........#.....#.#.#.#...#.....#.#.....#.#...#.#.#.#.#.......#.#.#.#.#.#.#.#.#...#.#.....#  
  #.###.#.###.###.#.###.###.###.#####.#####.#.###.#####.#.#.#####.#.###.###.#.#.#.#.#####.###.###.###.#.###.#.#.#####  
  #.#...#.....................#.#.#.......#.#.........#.#.#.......#.....#.......#.#...#.#...#.#.#.#.......#.....#.#.#  
  #####.###.#.###.###.#.#.#.#.###.#######.#.#############.#.###.###.#.#.#####.#.#.#####.#.###.#.#.#.###.#.#####.#.#.#  
  #.........#.#...#...#.#.#.#.#.#.#.......#.#.......#.....#.#.#.#...#.#.#.#...#...#.#.....#...#.....#.#.#.#.....#...#  
  #.#.#######.#############.###.#.###.#.#.#.#.###.#.#.#.#.#.#.#####.#####.###.#####.#.#####.#####.###.#########.#.#.#  
  #.#.#...#...#.#.#...........#.......#.#.#.#.#.#.#.#.#.#.#.#...#.....#.....#.....#.....#...#.....#...#...........#.#  
  ###.###.###.#.#.#######.#####.###.#######.#.#.#.#####.###.#.###.###.###.#######.#.#.#####.###.#.#.#.#######.#######  
  #.#...#.#...#.#...#.#.......#.#...#.#.#.....#.#.....#...#.....#.#...#.#.....#.#...#...........#.#.#.#...#.......#.#  
  #.#####.#####.#.#.#.###.#########.#.#.#.###.###.#######.#.#.#######.#.###.###.#.###.#.#.###.###.#.###.#####.#.###.#  
  #...#...........#...#.#.#.#.#.#.....#.#...#.#.....#.#.#.#.#.#.........#.........#...#.#...#...#.#...#.#.....#.#...#  
  #.#######.#####.###.#.###.#.#.#####.#.#.#######.#.#.#.#.###.###.#.###.#.#.#.#.#.###.#######.#####.###.#######.#.#.#  
  #.....#...#.#...#.............#.#.....#.#...#...#.#.....#.#...#.#.#.#.#.#.#.#.#...#...#.............#.#.#...#...#.#  
  #.#########.#####.#######.###.#.#.#########.###.###.###.#.#.#.###.#.#####.#######.###.###.#.#.#.#####.#.#.###.#####  
  #.#.#.#.#...#.#.#.#.......#.#.....#.....#.........#.#...#...#...#...#.#.......#.#.#.#.#...#.#.#.#.#.#.#...#.......#  
  #.#.#.#.###.#.#.#####.#.#.#.#####.#.#.#######.#.###.###.#.#.#.###.###.###.#####.###.#.###########.#.#.#.#.###.###.#  
  #.#...#.....#...#.#...#.#...#.#...#.#.....#...#...#.#...#.#.#.#.#...#.#.#.#.#...#...#.#.....#.#.......#.#...#.#...#  
  #.###.#.#######.#.#######.###.###.#.###.#######.#####.###.#.#.#.#.###.#.#.#.#.###.#######.###.#.#####.###.###.#####  
  #...........#.......#.#.#.#.........#.#...#.#.....#.....#.#.#.#...#.#.#...#...#...#...#.#...#.#.#...#...#...#.....#  
  ###.###.###########.#.#.###.###.#.###.#.###.###.#######.#.#######.#.#.###.#.#.#.#.#.###.#.###.#####.#.###.###.#.###  
  #.....#...#.#.#.......#.#.#.#...#...#...#...#.#.#.......#.#.......#.#.#.....#.#.#.#...#.....#...#...#...#...#.#.#.#  
  ###.#######.#.###.#####.#.#####.#.###.#####.#.#.#.#.#####.###.#.#.#.#.###.###.#.###.###.#.#.#.#####.###.#.###.###.#  
  #.#.....#.#.#...#...#...#.......#.#.#.....#.#...#.#...#.....#.#.#.......#...#.....#.....#.#...#.#...#.#.#.#.#.#.#.#  
  #.#.###.#.#.###.#.###.#########.###.###.###.#.#.#.#.#.###.#.###.#######.#######.###.#.#.#######.#.###.#.#.#.#.#.#.#  
  #.#...#.#...#.#...#.#...#.#...#...#.......#...#.#.#.#.#...#...#.#.......#...........#.#.#...#...#.#.#.....#.......#  
  #.#.#######.#.#.#.#.#.###.#.#######.###########.#.#######.#######.###########.#############.###.#.#.###.###.###.###  
  #...#...#.....#.#.#...#.#.#.#      S           N P       R       Y           M        #.#.#.#...#...#.#...#.#.....#  
  ###.#.#####.#.###.###.#.#.#.#      J           D S       A       J           F        #.#.#.#.###.###.#.#######.###  
  #.#.#.#.#.#.#...........#.#.#                                                         #.......#.........#.........#  
  #.#.#.#.#.#####.###.#####.#.#                                                         #.#####.#.###.###.#.#####.###  
  #...#...#...#.#.#.#.#.#.#...#                                                         #.....#.....#.#.#.....#......KQ
  ###.###.#.###.#.#.#.#.#.#.###                                                         #####.###.#####.#.###########  
  #.#.....#.....#.#.....#.....#                                                         #.......#.#.#.#.#...#.......#  
  #.###.#######.#####.#.#.#.###                                                         #.#####.###.#.#.#.#.#######.#  
  #.#...#.#...#.....#.#.#.#...#                                                       SC..#...#.#.#.#.#.#.#.#.#.#.#.#  
  #.###.#.#.#####.###.#.#.#.###                                                         ###.#####.#.#.#.#####.#.#.#.#  
ZB....#.#...#.........#...#....UX                                                       #.....#...........#.......#..SJ
  #.###.###.#####.###.#.#######                                                         #.#.#.#.#.#####.###.###.#.#.#  
  #.................#.#.#.#...#                                                       UI..#.#...#.#...#.#.#.#.#.#...#  
  #.#.###.#####.###.#.###.#.###                                                         ###.#.#######.#.#.#.#.#####.#  
  #.#.#.#.#.#.#...#.#.#.#.....#                                                         #.#.#...#.........#.#...#...#  
  #.#.#.###.#.#########.#.###.#                                                         #.#.#######.#####.#.###.#####  
  #.#.#.#.#.#...#.......#.#...#                                                         #.#.#.....#.#.#.......#...#.#  
  #####.#.#.#.#.#######.#.#.###                                                         #.#####.#####.#########.###.#  
  #.#.#...#...#...#.#.....#...#                                                         #...#.....#...............#..RA
  #.#.#.###.#####.#.###.#.#.#.#                                                         #.#.#.#.###.#############.#.#  
JA..............#.......#.#.#..SD                                                     NC..#...#.#.....#.....#...#.#.#  
  #####.###.#.###.#############                                                         #.###.#.###.#####.#####.#.#.#  
UJ....#.#...#.#...#...#.#......JL                                                       #...#.#.#.............#.....#  
  #.#####.#######.#.#.#.#.###.#                                                         #######.#.#.###.#############  
  #.....#.#.....#.#.#...#...#..FW                                                       #.........#.#.#.#.#.#...#...#  
  #.#########.#####.###.#.#####                                                         #.###########.###.#.###.###.#  
YM....#...#.#.........#.......#                                                         #.#...........#.....#........ND
  #.#.#.#.#.#.#####.###.#######                                                         ###.#########.#.###.#.#.#####  
  #.#...#.......#.....#.....#.#                                                         #.#.........#...#.#...#.#.#.#  
  #######.###.###.###########.#                                                         #.#########.#####.#.#.###.#.#  
  #.....#...#.#.#.#.....#.#...#                                                       YT..........#.#...#...#...#...#  
  #.###.#######.###.#####.###.#                                                         ###.###.###.#.###.#########.#  
  #...#...#...#.#.....#.#......XQ                                                       #.#.#.........#...#...#...#.#  
  #.###.###.#.#.#.#.#.#.#.#.#.#                                                         #.#.#.#######.#####.###.###.#  
  #.#...#...#...#.#.#.#.#.#.#.#                                                       OY..#.#.#...#.#.#.#.....#.#...#  
  #.#.###.#.###.###.#.#.#####.#                                                         #.#####.###.###.###.#.#.#.#.#  
MF..#.....#.#.......#.........#                                                         #...#...............#.....#..YT
  #.###.#.#####.#.###########.#                                                         #.#####.#####.#######.###.#.#  
  #...#.#.#.#.#.#.#.#.......#.#                                                         #...#...#.#...#.#.......#.#.#  
  #.#######.#.#####.###.###.###                                                         #.#.#.###.###.#.#.###.#.#####  
  #.#.....#.....#...#...#.....#                                                         #.#.......#.....#.#...#.#...#  
  #####.###.#####.###.#.#.###.#                                                         ###.###.#####.#############.#  
LE......#.#.#.#.#...#.#.#.#...#                                                         #.#...#.#.#.#...#...#.....#..XQ
  #.#.#.#.#.#.#.###.#.#######.#                                                         #.#######.#.###.###.###.#.#.#  
  #.#.#...............#.#...#..YM                                                     ZB....#...#.#...#.#.....#.#...#  
  #####################.#.#####                                                         #.#####.#.###.#####.###.###.#  
  #.....#...............#.....#                                                         #.#...#...#.......#...#...#.#  
  #.###.#.#########.###.#.###.#                                                         #.#.#####.###.#####.#.###.###  
  #.#.#.#...#.......#...#...#..LE                                                       #...................#.....#.#  
  #.#.#.###.###.###.#.#####.###                                                         ###########################.#  
  #...#...#...#.#...#.#...#...#                                                         #.#.........................#  
  ###.###.#.###.###.#.#.#.#.###                                                         #.#.#.###.#.#.###.###.###.#.#  
YL......#...#.#.#...#...#.....#                                                         #.#.#.#.#.#.#.#.....#...#.#.#  
  ###.#######.###.#####.###.#.#                                                         #.###.#.#.###.###.#########.#  
  #.......#.#.....#.#...#...#.#                                                       JQ..#.#...#.#...#.....#.......#  
  ###.###.#.###.###.###.#.#.###                                                         #.#.###.###.###.###.###.#.###  
  #.....#...#...#.......#.#.#.#                                                         #.........#.#...#.....#.#....JL
  ###.#########.#####.#######.#    Y         A   I           M       U   K     J        #.#.###.#####.###.#########.#  
  #.........#.....#.....#.....#    L         C   J           V       J   Q     A        #.#.#...#.....#...#.#.......#  
  #.###.#.#####.#############.#####.#########.###.###########.#######.###.#####.#########.#####.#####.###.#.#####.###  
  #...#.#...#.....#.......#.#.........#.#.#.#...#.....#.......#.........#.....#.........#...#.#...#...#.....#...#...#  
  #####.#.#.#######.#####.#.#.###.#.###.#.#.#.#####.#######.#.#.#.#####.###.#.#######.#######.#.#.#.###.###.###.#.###  
  #.....#.#...#...#...#.#.#...#.#.#.#.........#.....#.......#.#.#...#...#...#.#.#.....#.#...#...#.#...#.#...#.......#  
  ###.#.#####.###.#.###.#.###.#.#.###.###.#######.#######.###.#.#######.###.#.#.#####.#.###.#.#.#######.###.###.###.#  
  #...#.....#...#...#.......#.#.....#.#...#.....#.#...#.....#.#.#.....#...#.#.....#.........#.#.......#.#.....#.#.#.#  
  #.#.#.#####.#######.#.#.#####.#.#######.#.#.###.#.#.#.#.#####.#.#.#######.#.###.###.###.###########.#.#.###.###.#.#  
  #.#.#...#...#.....#.#.#.......#...#.......#.#.#...#.#.#...#.#...#.....#...#...#.#.#.#.#.#...#...#...#.#.#.#.#.....#  
  ###.#.#.#########.#######.#####.#.###.#####.#.#####.#.#####.#####.#######.#.#####.#.#.###.#.#.#####.#####.#######.#  
  #...#.#.#.................#...#.#.#...#.#.#...#...#.#.#.....#.#.......#...#.#.....#.......#.#.....#.#...#.........#  
  #.###.#####.###.###.#.#.#.###.#.#####.#.#.#.###.#.#.#.#.#.###.#.#.#.#######.#####.#.###.#.#####.#####.###.###.#.#.#  
  #.#.....#...#.....#.#.#.#.#.......#...#.....#...#...#...#.#.....#.#.#.....#.#...#.....#.#...............#...#.#.#.#  
  ###.#.#######.#####.#####.###.#.#########.###.#.###.#.#####.#.#######.#.###.#.#####.###.#.#.#.#.###.#.###########.#  
  #.#.#...#.....#.......#...#.#.#.#.#.....#...#.#...#.#.#...#.#.#.#.#.#.#.........#.#...#.#.#.#.#...#.#.......#.....#  
  #.#.#.#.#####.#.#####.#.###.###.###.#.###.#.#.#######.#.#.###.#.#.#.###.#.#.#.###.#.###.###.###############.###.#.#  
  #.#.#.#.#.....#.#...#.#.#.....#.....#...#.#.#.#.#.....#.#.....#...#.....#.#.#...#.....#.#.#...........#.#.....#.#.#  
  #.###.#####.###.###.#.#.#.###.#.#.###.#.###.#.#.###.#.#####.#.#.###.#.###.###.###.#.#####.#####.#.#.###.#########.#  
  #.......#.#.#.#.#.....#.#.#.#.#.#.#...#.#...#.....#.#.#...#.#.#...#.#.#.....#...#.#.#.......#...#.#...........#...#  
  ###.#.#.#.###.#.###.#######.#.#####.#######.###.#####.#.#####.#.#####.#.#.#.#.#.###.#.#.#.###.###.###.###.#####.#.#  
  #...#.#...#.....#...#.#.#.#.#...#...#.#.#...#...#.#.....#...#...#.#.#.#.#.#.#.#.#.....#.#...#.#...#...#...#.#...#.#  
  ###.###.###.#.#.#####.#.#.#.###.#.###.#.#.#.#.#.#.###.###.###.#.#.#.#####.#########.###############.#.#####.###.#.#  
  #...#.#.#...#.#.#.#.#.#.#.#...........#.#.#.#.#...#.....#.....#.#.#.....#.#...#.....#.#.#...#.#.#.#.#...#.......#.#  
  ###.#.#####.#####.#.#.#.#.#.#######.###.###.#.#######.###.#.#.###.#.#####.#.#######.#.#.#.###.#.#.#######.#.###.#.#  
  #.#.#...#.#.#.#.............#.#.#...#.......#.......#.#.#.#.#.#.#...#.......#.#.#.#...................#.#.#...#.#.#  
  #.###.###.###.#######.###.###.#.#.#########.#.#######.#.#####.#.#.#####.#####.#.#.#.###.###############.#####.#####  
  #.........#.........#.#.....#.....#.....#.#.#...#.#.#...#.....#...#.#...#...#.#...#.#.#.......#.#...#...#.....#...#  
  #####.###.###.#####.#####.#####.#######.#.#.###.#.#.###.#####.#.#.#.#.###.#.#.#.#.#.#.#.#######.#.###.#.#####.#.###  
  #.....#.......#.............#...........#...#.......#...#.......#.#.......#...#.#.....#...............#.#.........#  
  #################################.###.###.#.#######.###.#######.###########.#####.#################################  
                                   A   U   Z M       S   P       U           J     O                                   
                                   A   X   Z V       C   S       I           Q     Y                                   `;

        const getGrid = function (str) {
            const grid = [];
            const chars = str.split("");
            let x = 0;
            let y = 0;
            chars.forEach(c => {
                if (c == " ") {

                } else if (c == ".") {
                    grid.push({ x, y })
                } else if (c == "\n") {
                    y++;
                    x = -1;
                } else if (c != "#") {
                    grid.push({ x, y, letter: c });
                }
                x++;
            });
            return grid;
        }

        const getUniquePortalName = function (name, grid) {
            if (grid.some(a => a.portal == name)) { return name + "1"; } else return name;
        }

        const getPortals = function (grid) {
            grid.filter(a => a.letter != null).forEach(a => {
                const oneLetter = a.letter;
                // Work out direction of grid
                if (grid.find(b => b.x == a.x && b.y == a.y - 1 && b.letter != null)) {
                    const twoLetter = grid.find(b => b.x == a.x && b.y == a.y - 1 && b.letter != null).letter;
                    const p = grid.find(b => b.x == a.x && b.y == a.y + 1);
                    if (p != null) { p.portal = getUniquePortalName(twoLetter + oneLetter, grid); }
                } else if (grid.find(b => b.x == a.x && b.y == a.y + 1 && b.letter != null)) {
                    const twoLetter = grid.find(b => b.x == a.x && b.y == a.y + 1 && b.letter != null).letter;
                    const p = grid.find(b => b.x == a.x && b.y == a.y - 1);
                    if (p != null) p.portal = getUniquePortalName(oneLetter + twoLetter, grid);
                } else if (grid.find(b => b.x == a.x - 1 && b.y == a.y && b.letter != null)) {
                    const twoLetter = grid.find(b => b.x == a.x - 1 && b.y == a.y && b.letter != null).letter;
                    const p = grid.find(b => b.x == a.x + 1 && b.y == a.y);
                    if (p != null) p.portal = getUniquePortalName(twoLetter + oneLetter, grid);
                } else if (grid.find(b => b.x == a.x + 1 && b.y == a.y && b.letter != null)) {
                    const twoLetter = grid.find(b => b.x == a.x + 1 && b.y == a.y && b.letter != null).letter;
                    const p = grid.find(b => b.x == a.x - 1 && b.y == a.y);
                    if (p != null) p.portal = getUniquePortalName(oneLetter + twoLetter, grid);
                } else {
                    throw "AAAHH";
                }
            });
            if (grid.filter(a => a.letter != null).length != (grid.filter(a => a.portal != null).length * 2)) throw "not matched";
            grid = grid.filter(a => a.letter == null);
            return grid;
        }

        const INNER = "inner";
        const OUTER = "outer";

        const markInnerOuter = function (grid) {
            const firstRow = grid.reduce((a, i) => a < i.y ? a : i.y);
            const lastRow = grid.reduce((a, i) => a > i.y ? a : i.y);
            const firstCol = grid.reduce((a, i) => a < i.x ? a : i.x);
            const lastCol = grid.reduce((a, i) => a > i.x ? a : i.x);
            grid.filter(a => a.portal != null).forEach(a => {
                if (a.x == firstCol || a.x == lastCol || a.y == firstRow || a.y == lastRow) {
                    a.type = OUTER;
                } else {
                    a.type = INNER;
                }
            });
        }

        const getDistances = function (grid) {
            grid.filter(a => a.portal != null).forEach(a => {
                const x = a.x;
                const y = a.y;
                getOptionsForItem(a, grid, { x: a.x, y: a.y });
            })
        }

        const getOptionsForItem = function (item, grid, amAt, wasAt = null, moved = 0) {
            const movements = [{ x: 1, y: 0 }, { x: 0, y: 1 }, { x: -1, y: 0 }, { x: 0, y: -1 }];
            movements.forEach(a => {
                const wouldBeAt = { x: amAt.x + a.x, y: amAt.y + a.y };
                if (wasAt != null && wouldBeAt.x == wasAt.x && wouldBeAt.y == wasAt.y) {
                    // NOT possible
                } else if (grid.find(a => a.x == wouldBeAt.x && a.y == wouldBeAt.y) != null) {
                    // possible
                    const n = grid.find(a => a.x == wouldBeAt.x && a.y == wouldBeAt.y);
                    if (n.portal != null) {
                        if (item.distances == null) item.distances = {};
                        if (item.distances[n.portal] != null) {
                            if (item.distances[n.portal] > moved + 1) {
                                item.distances[n.portal] = moved + 1;
                            }
                        } else {
                            item.distances[n.portal] = moved + 1;
                        }
                    } else {
                        // Keep moving
                        getOptionsForItem(item, grid, wouldBeAt, amAt, moved + 1);
                    }
                } else {
                    // NOT possible
                }
            })

        }

        const options = [];
        const getRoutes = function (portals, from, to, soFar = [], incomingLength = 0, incomingLevel = 0) {
            if (incomingLevel > portals.length / 2) return;
            if (options.some(a => a.length < incomingLength)) return;
            soFar = [...soFar];
            soFar.push({ p: from, level: incomingLevel });
            const starts = portals.filter(a => a.portal.startsWith(from.substr(0, 2)));
            starts.forEach(start => {
                let length = incomingLength;
                let level = incomingLevel;
                if (start.portal != from) {
                    if (start.type == INNER) {
                        level--;
                    } else if (start.type == OUTER) {
                        level++;
                    } else throw "oo";
                    length++;
                } else if (from != "AA") {
                    return;
                }
                if (level >= 0) {
                    const connectedToStart = Object.keys(start.distances).filter(a => a != "AA");
                    if (connectedToStart.some(a => a == to) && level == 0) {
                        options.push({ route: [...soFar, { p: to, level }], length: length + start.distances[to] });
                    }
                    const moreOptions = connectedToStart.filter(a => !patternFound(soFar, a, level) && a != to);
                    moreOptions.forEach(a => {
                        getRoutes(portals, a, to, soFar, length + start.distances[a], level);
                    });
                } else {
                    console.log(soFar);
                }
            });
        }

        const patternFound = function (arr, extra, l) {
            var newArray = arr.map(function (o, i) {
                if (i < arr.length - 1) {
                    return arr[i].p + "|" + arr[i + 1].p + "|" + arr[i].level;
                }
            });
            newArray.push(arr[arr.length-1].p + "|" + extra + "|" + arr[arr.length-1].level);
            newArray.sort();
            if (newArray.length > 500) return true;
            newArray = newArray.filter(function (o, i) {
                if (i < arr.length - 1) {
                    return (o == newArray[i + 1]);
                }
            });
            return newArray.length > 0;
        }
        //!soFar.some(b => b.p.startsWith(a.substr(0,2))) && 
        const g = getGrid(inp);
        const gg = getPortals(g);
        markInnerOuter(gg);
        getDistances(gg);

        const portals = gg.filter(a => a.portal != null);

        getRoutes(portals, "AA", "ZZ");

        options.sort((a, b) => a.length - b.length);
        console.log(options[0]);

    </script>



</body>

</html>
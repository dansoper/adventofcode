<html>

<body>
    <script>
        const parseStringToObject = function (s) {
            const grid = [];
            const ss = s.split("");
            let x = 0;
            let y = 0;
            ss.forEach(c => {
                let pos = { x, y };
                if (c == "#") {
                    pos.type = "wall";
                } else if (c == "@") {
                    pos.type = "me";
                } else if (c == ".") {
                    pos.type = null;
                } else if (c.charCodeAt(0) >= 65 && c.charCodeAt(0) <= 90) {
                    pos.type = "door";
                    pos.letter = c;
                } else if (c.charCodeAt(0) >= 97 && c.charCodeAt(0) <= 122) {
                    pos.type = "key";
                    pos.letter = c.toUpperCase();
                } else if (c == "\n") {
                } else {
                    throw "erm" + c;
                }
                if (pos.type != null) {
                    grid.push(pos);
                }
                if (c == "\n") {
                    x = 0;
                    y++;
                } else {
                    x++;
                }
            });
            return grid;
        }

        const parseObjectToString = function (o) {
            let building = "";
            for (let i = 0; ; i++) {
                const inThisRow = o.filter(a => a.y == i);
                if (inThisRow == null || inThisRow.length == 0) break;
                for (let j = 0; ; j++) {
                    const index = inThisRow.findIndex(a => a.x == j);
                    if (index >= 0) {
                        const it = inThisRow[index];
                        if (it.type == "wall") {
                            building += "#";
                        } else if (it.type == "me") {
                            building += "@";
                        } else if (it.type == "key") {
                            building += it.letter.toLowerCase();
                        } else if (it.type == "door") {
                            building += it.letter;
                        } else {
                            throw "not";
                        }
                        inThisRow.splice(index, 1);
                    } else {
                        building += ".";
                    }
                    if (inThisRow.length == 0) break;
                }
                building += "\n";
            }
            return building;
        }
        const o = parseStringToObject(`#################################################################################
#...#..j..........#.........#...........#.......#........n......#.....#........m#
#.#.#.#.###########.###.#####.#######O#####.###.#.#########.#.###.#.###.###.###.#
#.#.#.#...............#.Z.......#...#...#...#.#.#.#.......#.#.....#.....#.X.#...#
#.#.#.###########################P#.#.#.#.###.#.###.#####.###.###########.###.###
#.#.#.#.......#.........#......b..#.#.#.#.#.......#...#.#...#.....#.......#.....#
#.#.#.#.###.###.#######.#.#########.###.#.#######.###.#.###.#####.#.#############
#.#.#.#.#...#...#..l#...#.#.......#.#...#.....#.......#.#...#.....#.........#..k#
#.###.#.###.#.#####.#.###.#######.#.#.###.###.#########.#.###.#####.#######.#.#.#
#...#.#...#.#.#...#...#...#.....#.#...#.#...#...#.....#.#.#...#...#...#...#...#.#
#.#.#.#.#.###.#.#U###.###.#.###.#.#####.###.###.#.###.#.#.#.###.#.#####.#.#####F#
#.#.#.#.#...#...#...#.....#.#...#.......#...#g#...#.#.#...#.#...#...#.E.#.....#.#
#.#.#.#.###.#######.#######.###.###Y#.###.###.#####.#.###.###.#####.#.#######.#.#
#.#...#...#...#.....#......a..#...#.#...#.....#.....#...#.....#.......#.....#...#
#.#####D#####.#.#######.#####.###.###.#.#####.#.###.###.#################.#####.#
#.M...#.#...#.#.#c....#...#...#.#...#.#.#...#.#.#.#.#.#.#...............#...#...#
#####.###.#.#.#H#.###.#####.###.###.#.#.#.###.#.#.#.#.#.#.###########.#.###.#.###
#...#.....#.#.#.#...#...#...#.....#.#.#.#...#.#.#.....#.......#.....#.#.#...#.#.#
#.#.#######.#.#.#.#####.#.###.#.###.###.#.#.#.#.#####.#########.###.###.#.###.#.#
#.#.#....x#.#.#...#.....#.#...#.#..i#...#.#.#.#...#...#.........#.....#.#...#...#
#.###K#.#.#.#.#####.#####.#.###.#.###.#####.#.###.#####.###.#########.#.#.#.###.#
#...#.#.#.#.#.....#..r#...#...#.#.#.....#...#.....#.....#...#.......#...#.#.....#
#.#.#.#.###.#.###.#####.#####.#.#.#.###.#.#####.###.#####.#########.#####.#####.#
#.#.#.#.....#.#.........#.....#.#.#...#.#.......#...#...#.#.........#.....#...#.#
###.#.#########.#########.#####.#.#####.#####.###.#.#.#.###.#########.#####.#.#.#
#...#...#.....#.#...........#...#.....#.#..t#.#.#.#.#.#.....#...#.........#.#.#.#
#.#####.#.#.#.#.#####.#####.#########.#.#.#.#.#.#.#.#.#######.###.#########.#.###
#.......#.#.#.#.....#...#.#.....#...#.#.#.#.#...#.#.#.....#.......#...#...#.#...#
#.#########.#.###.#.###.#.#####.#.#.#.#.#.#.#####.#.#####.#########.#.#.#.#.###.#
#.#.....#...#...#.#.#...#...#...#.#...#.#.#.......#.#...#.......#q..#...#...#...#
#.###.#.#.#####.###.###.#.###.###.#####.#.#########.###.#######.#.###########.###
#.....#.#...#.#...#...#.#...#...#...#...#...#...#.#.....#.......#.#...#.....#...#
#######.#.#.#.###.#.#.#.###.###.###.###.#.#.#.#.#.#####.#.#######.#.###.#.#####.#
#.....#.#.#.#.....#.#.#.......#...#.....#.#.#.#.#.#.....#.#...#...#...#.#.....#.#
#.#.###.#.#.###.#####.#####.###.#.#####.#.#.#.#.#.#.#####.#.#.#.#####.#.#####.#.#
#.#.#...#.#...#.#...#.#.....#...#...#...#.#...#.#...#...#...#...#.....#.#.....#.#
###.#.###.###.#.#.#.#.#######.#######.###.#####.#.###.#.#########.#.###.#.###.#.#
#...#.#...#...#.#.#.#...#.....#.....#.#.#.#...#.#.#...#.......#...#.....#...#.#.#
#.###.#####.###.#.#.###.#.#####.###.#.#.#.###.#.###.#######.###.###########.###.#
#...........#.....#.....#.........#...........#...........#...............#w....#
#######################################.@.#######################################
#.....#.....#.......#.........#...................#.#...................#...#...#
#.###.###.#.#.#####.#.#.#####.#.#####.#.#.#######.#.#.###############.#.#.#.#.#.#
#...#.....#...#.#...#.#...#.#.#.#.#...#.#.......#...#...#...#...#...#.#...#...#.#
###.#####.#####.#.#######.#.#.#.#.#.###.#.#####.###.###.#.###.#.#.#.#.#########.#
#...#...#.#...#.#.....#...#...#...#...#.#.#...#...#.#...#.#...#...#.#.........#.#
#.###.#.###.#.#.#####.#.###.#########.#.#.###.###.###.###.#.#######.###########.#
#.....#.....#.#.....#...#.#.#.......#.#.#.......#.....#...#.#...................#
#############.#####.#####.#.#.#####.#.#.#######.#######.#.#.###.###############.#
#...........#.....#.......#.#...#.#.#.#.#.....#.........#.#...#.#.........#...#.#
#########.#.#####.#.###.###.###.#.#.#.###.#.#.#######T#######.###.#######.#.###.#
#........f#.#...#.#...#.....#...#...#...#.#.#.#.....#.#.......#...#...#...#.#...#
#.#######.###.#.#.#####.#####.###.#####.#.#.#.#.###.#.#.#######.#####.#.###.#.###
#.#.#.....#...#.#.....#.......#...#.....#.#.#.#.#.#...#.#...#.......#.#.#.......#
#.#.#.#####.###.#.###.#########.###.#.###.#.###.#.#####.#.#.#.#####.#.#.#######.#
#.#.#...#...#.#.#...#.#...#...#.#.#.#...#.#...#.#...#...#.#...#...#...#.#.....#.#
#.#.###.#.###.#.###.#.###.#.#.#.#.#.###.#####.#.#.#.#.###.#####.#.#####.#.###.#.#
#.#.....#.#...#...#.#...#...#.#.#...#.#.#.....#.#.#.#.......#...#.#...#....s#.#v#
#.#.#####.#.#.###.###.#.#.###.#.###.#.#.#.#####.###.#####.###.###.#.#.#######.#.#
#.#...#...#.#...#...#.#.#...#.#...#..y#.#.#.........#...#.#...#.....#.........#.#
#.###.#.#######.###.###.#####.###.#####.#.#.#####.###.#.###.#########.###########
#.#...#.........#.#...#.....#...#.#.....#...#...#.#...#...#.#.......#.#.........#
#.#.###########.#.#########.#.###.#.#########.#.#.#.#####.#.#######R###.#######.#
#.#.#.....Q...#...#.........#...#.#.#...#...#.#.#.#.#...#.....#...#.....#...#.C.#
#.###.#.#########.#.###.#######.#.#.#.#.#.#.#.#.#.#.###.#####.#.#.#########.#.###
#...#.#...#...G.#.#...#.#.#.....#.#...#.#.#.#.#.#.#...#...#...#.#.....#.....#.#.#
#.#.#.###.#.###.#.#####.#.#.#.###.#####.#.#.#.#.#.###.#.#.#.#####.###.#.#####.#.#
#.#.#...#.#.#...#.#.....#.#.#.#...#...I.#.#...#.#...#.#.#.#.#.....#.#...#...#...#
#.#S###.#.#.#.#.#.#.#####.#.#.#.###.###.#.#####.#####.#.#.#.###.###.###.#.#.###.#
#.#.....#...#.#.#...#.......#...#...#.#.#.....#.......#.#.#...#.#.#...#.#.#.....#
#.###########.#######.###########.###.#.#.###.#########.#.###.#.#.#.#.#.#.#######
#e#.......#...#.....#.#.......#...#.#...#.#...#...#.#...#.......#...#...#.#.....#
#.#.#######.#.#.#.###.#.###.###.#.#.#.###N#.###.#.#.#.#########.#####.###.#.###.#
#.#.#.......#.#.#.....#...#.#...#.#.....#.#.#...#.#.#.#..p..#...#...#...#h..#.#.#
#.#.#.#########W#########.#.#.###.#####.###.#.###.#.#.#.###.#####.#B#########.#.#
#...#d....#...#.....#...#.#.....#.....#.#...#.#.#.#.#.#...#.#.....#.#.......#...#
###.#####.#.#.#####.#.#.###.#######.#.#.#.###.#.#.#.#.###.#.#.#####.#.#####.#.###
#...#...#...#.....#...#.V.#.#.....#.#.#.#.#...#z#.#...#...#.#...#.#...#.#.L.#.#.#
#.#####.#######.#########.###.###.###.#.#.#.###J#.#####.###.###.#.#####.#.###.#.#
#.............#...............#.....A.#.#.......#........o#.............#....u..#
#################################################################################`);

        const copyObject = function (o) {
            return o.map(a => { return { ...a } });
        }

        const getPossibleMovements = function (o, wasAt, allowBack) {
            const me = o.find(a => a.type == "me");
            const poss = [
                { x: -1, y: 0 },
                { x: 1, y: 0 },
                { x: 0, y: -1 },
                { x: 0, y: 1 }
            ];
            const possForMe = [];
            poss.forEach(p => {
                debugger;
                const wouldBeAt = { x: me.x + p.x, y: me.y + p.y };
                if (allowBack || (wasAt.x != wouldBeAt.x || wasAt.y != wouldBeAt.y)) {
                    const there = o.find(a => a.x == wouldBeAt.x && a.y == wouldBeAt.y);
                    if (there == null || (there.type != "door" && there.type != "wall")) {
                        possForMe.push(p);
                    }
                }
            });
            return possForMe;
        }

        const move = function (o, m) {
            const oo = copyObject(o);
            const me = oo.find(a => a.type == "me");
            me.x += m.x;
            me.y += m.y;
            const clash = oo.find(a => a.x == me.x && a.y == me.y && a.type != "me");
            if (clash != null) {
                if (clash.type == "key") {
                    const door = oo.findIndex(a => a.type == "door" && a.letter == clash.letter);
                    if (door >= 0) {
                        oo.splice(door, 1);
                    }
                    oo.splice(oo.findIndex(a => a.x == me.x && a.y == me.y && a.type != "me"), 1);
                } else {
                    throw "WSS";
                }
            }
            return oo;
        }

        let bestSoFar = null;
        const beens = [];

        const beenHereBefore = function(o, i) {
            return beens.find(a => a.been == parseObjectToString(o) && a.count <= i) != null;
        }

        const go = function (o, count = 0, good = false, wasAt = {}) {
            const counts = [];
            if (bestSoFar != null && count > bestSoFar) return counts;
            //if (beenHereBefore(o, count)) return counts;
            //beens.push({ been: parseObjectToString(o), count });
            //console.log(parseObjectToString(o));
            const mvts = getPossibleMovements(o, wasAt, good);
            //console.log(count);
            //console.log(mvts.length);
            for (let i = 0; i < mvts.length; i++) {
                const m = mvts[i];
                const oldMe = o.find(a => a.type == "me");
                const newO = move(o, m);
                if (keyCount(newO) == 0) {
                    if (bestSoFar == null || bestSoFar > count + 1) {
                        bestSoFar = count + 1;
                        console.log(parseObjectToString(newO));
                        counts.push(count + 1);
                    }
                    break;
                }
                let goodMove = false;
                if (keyCount(o) != keyCount(newO) || doorCount(o) != doorCount(newO)) goodMove = true;
                addToLevel(count + 1, newO, goodMove, oldMe);
                //const cs = go(newO, count + 1, goodMove, oldMe);
                //cs.forEach(a => {
                //    counts.push(a);
                //});
            }
            return counts;
        }

        levels = [];
        const addToLevel = function(level, o, goodMove, oldMe) {
            if (levels[level] == null) levels[level] = [];
            levels[level].push({ o, goodMove, oldMe });
        }

        const doorCount = function (o) {
            return o.filter(a => a.type == "door").length;
        }
        const keyCount = function (o) {
            return o.filter(a => a.type == "key").length;
        }

        const c = go(o);
        for (let i = 1;; i++) {
            if (levels[i] != null) {
                levels[i].forEach(l => {
                    go(l.o, i, l.goodMove, l.oldMe);
                })
            } else break;
        }
        console.log(c);
    </script>



</body>

</html>